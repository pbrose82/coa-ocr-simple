<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alchemy OCR Intelligence</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- AG Grid CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine.css">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        .ag-cell {
            font-size: 14px;
        }
        
        .ag-header-cell-text {
            font-weight: 600;
            color: var(--alchemy-dark);
        }
        
        .field-label {
            font-weight: 600;
            color: var(--alchemy-dark);
        }
        
        .field-value {
            color: #333;
        }
        
        .object-value-cell {
            overflow: hidden;
        }
    .ag-theme-alpine .ag-cell {
        padding: 8px;
        line-height: 1.5;
        overflow: visible;
        height: auto;
    }
    
    .ag-theme-alpine {
        --ag-row-height: auto;
        --ag-cell-horizontal-padding: 8px;
    }
    
    /* Better handling of HTML content in cells */
    .ag-cell-wrapper.ag-row-odd {
        background-color: #f9f9f9;
    }
    
    .ag-cell-value {
        width: 100%;
        height: 100%;
        overflow: visible;
    }
    
    /* Result box takes full width */
    .result-box {
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
    }
    
    /* Data grid appears above the fold */
    .ocr-section {
        max-width: 100%;
        width: 100%;
    }
    
    @media (min-width: 992px) {
        .main-content {
            max-width: 90%; 
        }
        
        .ocr-section {
            width: 90%;
            max-width: 1200px;
        }
    }
</style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-container">
            <i class="fas fa-file-alt header-logo"></i>
            <h1 class="header-title">Alchemy OCR Intelligence</h1>
        </div>
    </div>
    
    <!-- App Info Banner -->
    <div class="tenant-banner">
        <div class="tenant-container">
            <div class="tenant-info">
                Extract text and data from your documents with advanced OCR and AI
                <a href="/training" class="btn btn-sm btn-outline-primary ms-3">
                    <i class="fas fa-brain me-1"></i> Train AI Model
                </a>
                <a href="/model-explorer" class="btn btn-sm btn-outline-info ms-2">
                    <i class="fas fa-search me-1"></i> Explore AI Models
                </a>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- OCR Section -->
        <div class="ocr-section">
            <div class="form-group mb-4">
                <label class="form-label">Select Document Type</label>
                <select class="form-select" id="fileFormat">
                    <option value="pdf" selected>PDF Document</option>
                    <option value="image">Image (JPG, PNG, TIFF)</option>
                </select>
            </div>
            
            <div class="form-group mb-4">
                <label class="form-label">Upload Document</label>
                <div class="file-upload" id="dropZone">
                    <div class="file-upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <p class="file-upload-text">Drag & drop your file here</p>
                    <p class="file-upload-hint">or</p>
                    <label for="fileInput" class="custom-file-upload">Choose File</label>
                    <input type="file" id="fileInput" name="file" accept=".jpg,.jpeg,.png,.pdf,.tiff" hidden>
                    <div id="fileName" class="file-info" style="display: none;">
                        <i class="fas fa-file-alt"></i>
                        <span id="fileNameText"></span>
                    </div>
                </div>
            </div>
            
            <div class="button-group">
                <button id="extractButton" class="btn-extract disabled" disabled>EXTRACT DATA</button>
                <button id="sendToAlchemy" class="btn-submit" disabled>SUBMIT TO ALCHEMY</button>
                <button id="resetButton" class="btn-reset">RESET</button>
            </div>
            
            <!-- Processing Status -->
            <div id="processingStatus" style="display: none;" class="alert alert-info mt-3">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <span id="statusText">Processing document...</span>
                </div>
                <div class="progress mt-2">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Alchemy Record Link -->
            <div id="alchemyRecordLink" style="display: none;" class="alert alert-success mt-3">
                <p>Data successfully sent to Alchemy!</p>
                <p><a href="#" id="recordLink" target="_blank" class="alert-link">View record in Alchemy</a></p>
            </div>
            
            <!-- Results Box with AG Grid -->
            <div id="results" style="display: none;" class="result-box">
    <h5>Extracted Data</h5>
    
    <!-- Improved container for AG Grid with better size handling -->
    <div id="extractedDataGrid" class="ag-theme-alpine" style="width: 100%; height: auto; min-height: 400px;"></div>
    
    <div class="mt-4">
        <h5>Raw Text</h5>
        <div id="rawText" class="raw-text"></div>
    </div>
</div>
        
        <!-- Tips Section -->
        <div class="tips-section">
            <div class="tips-title">
                <i class="fas fa-lightbulb"></i>
                Tips for best results:
            </div>
            <ul class="tips-list">
                <li>Image files (JPG, PNG) process faster than PDFs</li>
                <li>PDFs with embedded text work best</li>
                <li>Use clear, high-resolution images of your documents</li>
                <li>You can drag and drop files directly onto the upload area</li>
                <li>Train the AI model with sample documents to improve extraction</li>
            </ul>
        </div>
    </div>
    
    <!-- Footer -->
    <div class="footer">
        <div class="footer-content">
            <img src="{{ url_for('static', filename='Alchemy-logo.svg') }}" alt="Alchemy Cloud Logo" class="footer-logo">
            <div class="copyright">Â© ALCHEMY CLOUD, INC. ALL RIGHTS RESERVED.</div>
        </div>
    </div>
    
    <!-- AG Grid JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>
    
    <!-- JavaScript for file upload handling -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const fileNameDisplay = document.getElementById('fileName');
            const fileNameText = document.getElementById('fileNameText');
            const dropZone = document.getElementById('dropZone');
            const extractButton = document.getElementById('extractButton');
            const fileFormat = document.getElementById('fileFormat');
            const resetButton = document.getElementById('resetButton');
            
            // File input change handler
            fileInput.addEventListener('change', function() {
                handleFileSelection(this.files);
            });
            
            // File format change handler
            fileFormat.addEventListener('change', function() {
                if (fileFormat.value === 'image') {
                    fileInput.accept = ".jpg,.jpeg,.png,.tiff";
                } else {
                    fileInput.accept = ".pdf";
                }
            });
            
            // Reset button handler
            resetButton.addEventListener('click', function() {
                window.location.reload();
            });
            
            // Drag and drop handling
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropZone.classList.add('highlight');
            }
            
            function unhighlight() {
                dropZone.classList.remove('highlight');
            }
            
            dropZone.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                handleFileSelection(files);
            }
            
            function handleFileSelection(files) {
                if (files.length > 0) {
                    const file = files[0];
                    
                    // Display file name
                    fileNameText.textContent = file.name;
                    fileNameDisplay.style.display = 'flex';
                    
                    // Enable extract button
                    extractButton.classList.remove('disabled');
                    extractButton.classList.add('active');
                    extractButton.disabled = false;
                    
                    // Add selected class to drop zone
                    dropZone.classList.add('file-selected');
                    
                    // Sync the file input
                    if (files !== fileInput.files) {
                        // This is tricky and not always possible due to security restrictions
                        // You may need to handle this differently depending on the browser
                        try {
                            // Create a new FileList-like object and assign it
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(file);
                            fileInput.files = dataTransfer.files;
                        } catch (e) {
                            console.error('Unable to set files programmatically:', e);
                            // Let the user know they need to use the file input directly
                            const notification = document.createElement('div');
                            notification.className = 'alert alert-warning mt-2';
                            notification.innerHTML = 'Please use the Choose File button for better compatibility.';
                            notification.style.fontSize = '12px';
                            notification.style.padding = '5px 10px';
                            fileNameDisplay.appendChild(notification);
                            
                            // Remove after a delay
                            setTimeout(() => {
                                fileNameDisplay.removeChild(notification);
                            }, 5000);
                        }
                    }
                }
            }
        });
    </script>
    
    <!-- AG Grid with custom cell renderer for object data -->
    <script>
        class ObjectValueRenderer {
            init(params) {
                this.eGui = document.createElement('div');
                if (params.value === null || params.value === undefined) {
                    this.eGui.innerHTML = '';
                    return;
                }
                
                // Check if value is an object
                if (typeof params.value === 'object') {
                    let html = '<div class="object-value-cell">';
                    // Create a simple table for the object's properties
                    if (Object.keys(params.value).length > 0) {
                        html += '<table class="table table-sm table-bordered mb-0">';
                        for (const key in params.value) {
                            html += `
                                <tr>
                                    <td style="font-weight: 500;">${key}</td>
                                    <td>${typeof params.value[key] === 'object' ? 
                                         JSON.stringify(params.value[key]) : 
                                         params.value[key]}</td>
                                </tr>
                            `;
                        }
                        html += '</table>';
                    } else {
                        html += '<span class="text-muted">Empty object</span>';
                    }
                    html += '</div>';
                    this.eGui.innerHTML = html;
                } else {
                    // Just a simple value
                    this.eGui.innerHTML = params.value;
                }
            }
            
            getGui() {
                return this.eGui;
            }
        }
    </script>
    
    <!-- Custom script for AG Grid handling -->
    <script>
        // Global variable to store the grid
        let extractedDataGrid;
        
        // Add this to the index.html file, replacing the existing grid initialization code

// Modify the grid container element to have responsive height
// Find <div id="extractedDataGrid" class="ag-theme-alpine" style="height: 400px; width: 100%;"></div>
// And replace with:
// <div id="extractedDataGrid" class="ag-theme-alpine" style="height: auto; min-height: 400px; width: 100%;"></div>

// Then update the initializeGrid function:
function initializeGrid() {
    const gridDiv = document.getElementById('extractedDataGrid');
    
    // Create column defs for key-value pairs
    const columnDefs = [
        {
            headerName: 'Field',
            field: 'field',
            cellClass: 'field-label',
            minWidth: 150,
            maxWidth: 250,
            filter: true,
            floatingFilter: true,
            sortable: true
        },
        {
            headerName: 'Value',
            field: 'value',
            cellClass: 'field-value',
            minWidth: 300,
            flex: 3,
            cellRenderer: 'htmlCellRenderer',
            autoHeight: true,
            wrapText: true
        }
    ];
    
    // Set up grid options
    const gridOptions = {
        columnDefs: columnDefs,
        rowData: [],
        defaultColDef: {
            resizable: true
        },
        domLayout: 'autoHeight',
        suppressMovableColumns: true,
        animateRows: true,
        components: {
            htmlCellRenderer: HtmlCellRenderer
        },
        // Adjust row height for content
        headerHeight: 40,
        getRowHeight: function(params) {
            // Check if we have HTML content that needs more space
            if (params.data && params.data.value && 
                typeof params.data.value === 'string' && 
                params.data.value.includes('<table')) {
                return 300; // Give test results more space
            }
            return 48; // Default row height
        },
        onGridReady: function(params) {
            // Auto-size all columns when grid is ready
            params.api.sizeColumnsToFit();
            
            // Handle window resize
            window.addEventListener('resize', function() {
                setTimeout(function() {
                    params.api.sizeColumnsToFit();
                });
            });
        }
    };
    
    // Create grid
    extractedDataGrid = new agGrid.Grid(gridDiv, gridOptions);
    return gridOptions;
}

// Improve the HtmlCellRenderer implementation
class HtmlCellRenderer {
    init(params) {
        this.eGui = document.createElement('div');
        this.eGui.style.width = '100%';
        this.eGui.style.height = '100%';
        this.eGui.style.overflow = 'auto';
        
        if (params.value === null || params.value === undefined) {
            this.eGui.innerHTML = '';
            return;
        }

        if (typeof params.value === 'string' && params.value.trim().startsWith('<table')) {
            this.eGui.innerHTML = params.value;
            
            // Ensure tables take full width
            const tables = this.eGui.querySelectorAll('table');
            tables.forEach(table => {
                table.style.width = '100%';
            });
        } else {
            this.eGui.textContent = params.value;
        }
    }

    getGui() {
        return this.eGui;
    }
}
        
        // Update grid with extracted data
        function updateGridWithData(data) {
            // Skip rawText since we display it separately
            const rowData = [];
            
            // Check if we have any data other than full_text
            const hasData = Object.keys(data).filter(key => key !== 'full_text').length > 0;
            
            if (!hasData) {
                rowData.push({
                    field: 'No structured data',
                    value: 'No structured data could be extracted. See the raw text below.'
                });
            } else {
                // Transform the data into rows
                for (const key in data) {
                    if (key !== 'full_text') {
                        const value = data[key];
                        
                        // Skip null/undefined values or empty strings
                        if (value === null || value === undefined || value === '') {
                            continue;
                        }
                        
                        // Format the field name
                        const formattedKey = key.replace(/_/g, ' ')
                                             .replace(/\b\w/g, l => l.toUpperCase());
                        
                        // Add to row data
                        rowData.push({
                            field: formattedKey,
                            value: value
                        });
                    }
                }
            }
            
            // Update the grid
            extractedDataGrid.gridOptions.api.setRowData(rowData);
            
            // Auto-size columns
            extractedDataGrid.gridOptions.columnApi.autoSizeAllColumns();
        }
    </script>
    
    <!-- Main application script with AG Grid integration -->
    <script>
        // Wait for the DOM to be fully loaded before executing
        document.addEventListener('DOMContentLoaded', function() {
            // Define variables for various HTML elements
            const fileInput = document.getElementById('fileInput');
            const extractButton = document.getElementById('extractButton');
            const results = document.getElementById('results');
            const rawText = document.getElementById('rawText');
            const sendToAlchemy = document.getElementById('sendToAlchemy');
            const processingStatus = document.getElementById('processingStatus');
            const statusText = document.getElementById('statusText');
            const progressBar = document.getElementById('progressBar');
            const alchemyRecordLink = document.getElementById('alchemyRecordLink');
            const recordLink = document.getElementById('recordLink');
            
            // Initialize the AG Grid
            const gridOptions = initializeGrid();
            
            // Initialize UI state
            updateUIState();
            
            // Extract button click handler
            if (extractButton) {
                extractButton.addEventListener('click', function() {
                    extractDocument();
                });
            }
            
            // Send to Alchemy button click handler
            if (sendToAlchemy) {
                sendToAlchemy.addEventListener('click', function() {
                    sendDataToAlchemy();
                });
            }
            
            // Update UI state based on current inputs
            function updateUIState() {
                const hasFile = fileInput && fileInput.files && fileInput.files.length > 0;
                
                // Extract button state
                if (extractButton) {
                    if (hasFile) {
                        extractButton.classList.remove('disabled');
                        extractButton.classList.add('active');
                        extractButton.disabled = false;
                    } else {
                        extractButton.classList.add('disabled');
                        extractButton.classList.remove('active');
                        extractButton.disabled = true;
                    }
                }
                
                // Send to Alchemy button
                if (sendToAlchemy) {
                    // Only enable if we have extraction results
                    const hasResults = results && results.style.display !== 'none';
                    
                    if (hasResults) {
                        sendToAlchemy.classList.add('active');
                        sendToAlchemy.disabled = false;
                    } else {
                        sendToAlchemy.classList.remove('active');
                        sendToAlchemy.disabled = true;
                    }
                }
            }
            
            // Reset results state
            function resetResults() {
                // Hide results section
                if (results) {
                    results.style.display = 'none';
                }
                if (alchemyRecordLink) {
                    alchemyRecordLink.style.display = 'none';
                }
                
                // Clear data grid
                if (extractedDataGrid && extractedDataGrid.gridOptions) {
                    extractedDataGrid.gridOptions.api.setRowData([]);
                }
                
                // Clear raw text
                if (rawText) {
                    rawText.textContent = '';
                }
                
                // Reset UI state
                updateUIState();
            }
            
            // Extract document data
            function extractDocument() {
                if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                    showNotification('Please select a file to extract', 'warning');
                    return;
                }
                
                const file = fileInput.files[0];
                const fileFormat = document.getElementById('fileFormat');
                const fileTypeMatch = fileFormat && (
                    (fileFormat.value === 'image' && file.type.startsWith('image/')) ||
                    (fileFormat.value === 'pdf' && file.type === 'application/pdf')
                );
                
                if (fileFormat && !fileTypeMatch) {
                    showNotification(`Selected file doesn't match the chosen file type (${fileFormat.value})`, 'error');
                    return;
                }
                
                // Clear previous results
                resetResults();
                
                // Show processing status
                if (processingStatus) {
                    processingStatus.style.display = 'block';
                }
                if (statusText) {
                    statusText.textContent = 'Uploading document...';
                }
                if (progressBar) {
                    progressBar.style.width = '10%';
                }
                
                // Set up simulated progress for user feedback
                let progress = 10;
                const progressInterval = setInterval(() => {
                    if (progress < 90 && progressBar) {
                        progress += Math.random() * 5;
                        progressBar.style.width = `${progress}%`;
                        
                        // Update status text based on progress
                        if (statusText) {
                            if (progress > 20 && progress < 40) {
                                statusText.textContent = 'Processing document...';
                            } else if (progress > 40 && progress < 60) {
                                statusText.textContent = 'Extracting text...';
                            } else if (progress > 60 && progress < 80) {
                                statusText.textContent = 'Analyzing data...';
                            }
                        }
                    }
                }, 1000);
                
                // Prepare form data
                const formData = new FormData();
                formData.append('file', file);
                
                // Send request to extract endpoint
                fetch('/extract', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    clearInterval(progressInterval);
                    
                    if (!response.ok) {
                        throw new Error(`Error: ${response.status} ${response.statusText}`);
                    }
                    
                    return response.json();
                })
                .then(data => {
                    // Complete progress bar
                    if (progressBar) {
                        progressBar.style.width = '100%';
                    }
                    if (statusText) {
                        statusText.textContent = 'Processing complete!';
                    }
                    
                    // Hide processing after delay
                    setTimeout(() => {
                        if (processingStatus) {
                            processingStatus.style.display = 'none';
                        }
                    }, 1000);
                    
                    // Handle error in response
                    if (data.error) {
                        showNotification(`Error: ${data.error}`, 'error');
                        return;
                    }
                    
                    // Display the results
                    displayResults(data);
                    
                    // Update UI state
                    updateUIState();
                })
                .catch(error => {
                    // Clear interval
                    clearInterval(progressInterval);
                    
                    // Hide processing status
                    if (processingStatus) {
                        processingStatus.style.display = 'none';
                    }
                    
                    console.error('Error during extraction:', error);
                    showNotification(`Error: ${error.message}`, 'error');
                });
            }
            
            // Display extraction results with AG Grid
            function displayResults(data) {
                if (!results || !rawText) {
                    console.error('Results elements not found');
                    return;
                }
                
                // Update the AG Grid with data
                updateGridWithData(data);
                
                // Set raw text
                if (data.full_text) {
                    rawText.textContent = data.full_text;
                } else {
                    rawText.textContent = 'No raw text available';
                }
                
                // Show results
                results.style.display = 'block';
            }
            
            // Send extraction data to Alchemy
            function sendDataToAlchemy() {
                if (processingStatus) {
                    processingStatus.style.display = 'block';
                }
                if (statusText) {
                    statusText.textContent = 'Sending data to Alchemy...';
                }
                if (progressBar) {
                    progressBar.style.width = '50%';
                }
                
                // Get the data from the page (using the original data saved from extraction)
                fetch('/send-to-alchemy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({}) // The server already has the data from the last extraction
                })
                .then(response => response.json())
                .then(result => {
                    // Hide processing status
                    if (processingStatus) {
                        processingStatus.style.display = 'none';
                    }
                    
                    if (result.status === 'success') {
                        // Show the record link if available
                        if (result.record_url && alchemyRecordLink && recordLink) {
                            recordLink.href = result.record_url;
                            recordLink.textContent = `View record ${result.record_id} in Alchemy`;
                            alchemyRecordLink.style.display = 'block';
                        } else {
                            showNotification('Data successfully sent to Alchemy!', 'success');
                        }
                        
                        // Disable the send button
                        if (sendToAlchemy) {
                            sendToAlchemy.disabled = true;
                            sendToAlchemy.classList.remove('active');
                        }
                    } else {
                        showNotification(`Error: ${result.message || 'Failed to send data to Alchemy'}`, 'error');
                    }
                })
                .catch(error => {
                    // Hide processing status
                    if (processingStatus) {
                        processingStatus.style.display = 'none';
                    }
                    
                    console.error('Error sending to Alchemy:', error);
                    showNotification(`Error: ${error.message}`, 'error');
                });
            }
            
            // Show notification
            function showNotification(message, type) {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `alert alert-${type === 'error' ? 'danger' : 
                                              type === 'warning' ? 'warning' : 'success'} 
                                      position-fixed`;
                notification.style.top = '20px';
                notification.style.right = '20px';
                notification.style.zIndex = '9999';
                notification.style.maxWidth = '300px';
                notification.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                notification.style.animation = 'fadeIn 0.3s ease-out';
                
                // Add icon based on type
                let icon = '';
                if (type === 'error') {
                    icon = '<i class="fas fa-exclamation-circle me-2"></i>';
                } else if (type === 'warning') {
                    icon = '<i class="fas fa-exclamation-triangle me-2"></i>';
                } else {
                    icon = '<i class="fas fa-check-circle me-2"></i>';
                }
                
                notification.innerHTML = icon + message;
                
                // Add to document
                document.body.appendChild(notification);
                
                // Remove after delay
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.5s';
                    
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 500);
                }, 4000);
            }
        });

        // Add keyframe animation to stylesheet
        document.addEventListener('DOMContentLoaded', function() {
            const style = document.createElement('style');
            style.innerHTML = `
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(-20px); }
                    to { opacity: 1; transform: translateY(0); }
                }
            `;
            document.head.appendChild(style);
        });
    </script>
    
    <!-- COA Display Fixer -->
    <script src="{{ url_for('static', filename='js/coa_display_fixer.js') }}"></script>
</body>
</html>
